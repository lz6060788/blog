## Context

当前博客程序使用 NextAuth.js 实现多用户 OAuth 认证系统（GitHub 和 Google）。任何用户都可以通过 OAuth 登录访问系统。对于个人博客来说，这个功能过于复杂且增加了安全风险——只需要博主本人能够登录即可。

### 现状
- OAuth 提供商：GitHub、Google
- 用户存储：SQLite 数据库（users、accounts、sessions 表）
- 认证流程：标准 OAuth 2.0 授权码流程
- 会话管理：NextAuth.js 默认实现

### 约束
- 保持现有数据库结构不变
- 保持 NextAuth.js 框架
- 最小化代码改动
- 向后兼容现有会话（如有）

## Goals / Non-Goals

**Goals:**
- 限制登录为单一预配置邮箱地址
- 在 OAuth 回调阶段验证用户邮箱
- 提供清晰的错误信息给未授权用户
- 确保环境变量配置验证

**Non-Goals:**
- 实现用户角色/权限系统
- 修改数据库 schema
- 更换认证框架
- 实现多管理员支持

## Decisions

### 1. 在 OAuth 回调中验证邮箱
**决策**: 在 NextAuth.js 的 `callbacks.signIn` 中验证邮箱

**理由**:
- 最早可拦截点，避免创建不必要的用户记录
- NextAuth.js 原生支持，无需额外中间件
- 可直接访问 OAuth 返回的用户信息

**替代方案**:
- 在 `callbacks.session` 中验证：已创建用户记录，太晚
- 在 middleware 中验证：每个请求都验证，性能开销大
- 数据库触发器：过于复杂，不适合此场景

### 2. 使用环境变量存储白名单
**决策**: 使用单个 `ADMIN_EMAIL` 环境变量

**理由**:
- 简单直接，适合单用户场景
- 易于部署配置（Docker、Vercel 等）
- 未来可扩展为逗号分隔的多邮箱（如果需要）

**替代方案**:
- 数据库配置表：过度设计，单用户不需要
- 配置文件：部署时需要额外文件管理

### 3. 大小写不敏感比较
**决策**: 将邮箱转换为小写后比较

**理由**:
- OAuth 提供商可能返回不同大小写的邮箱
- RFC 5321 规定邮箱本地部分区分大小写，但实践中通常不区分
- 符合用户期望

### 4. 启动时验证环境变量
**决策**: 在 `lib/auth.ts` 加载时验证 `ADMIN_EMAIL`

**理由**:
- 快速失败，避免运行时才发现配置错误
- 提供清晰的错误信息

## Risks / Trade-offs

| Risk | Mitigation |
|------|------------|
| 邮箱变更需要重启应用 | 接受：单用户博客，管理员邮箱变更频率低 |
| OAuth 提供商返回邮箱格式不一致 | 统一转小写处理，trim 空格 |
| 环有已注册的非管理员用户 | 接受：保留现有用户数据，只是阻止新登录 |
| 开发环境与生产环境邮箱不同 | 使用 .env.local 配置不同值 |

## Migration Plan

### 部署步骤
1. 设置 `ADMIN_EMAIL` 环境变量
2. 部署新代码
3. 验证管理员可以登录
4. 验证非管理员被拒绝

### 回滚策略
- 移除 `ADMIN_EMAIL` 环境变量
- 回滚代码到之前版本
- 恢复多用户登录功能

### 数据迁移
- 无需数据库迁移
- 现有用户记录保留（但无法登录）

## Open Questions

1. **是否需要登录页面显示错误详情？**
   - 建议：显示通用错误"未授权访问"，避免泄露管理员邮箱

2. **是否需要添加开发模式绕过？**
   - 建议：不添加，保持开发和生产环境一致

3. **未来是否需要支持多个管理员？**
   - 建议：如果需要，可将 `ADMIN_EMAIL` 改为逗号分隔列表
