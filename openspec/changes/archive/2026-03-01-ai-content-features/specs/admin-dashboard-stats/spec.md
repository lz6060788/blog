# Admin Dashboard Stats - AI 功能扩展

## ADDED Requirements

### Requirement: AI 配置集成到设置页面
系统应将 AI 模型配置和功能映射集成到现有的设置页面。

#### 场景：设置页面显示 AI 配置卡片
- **当** 管理员访问 `/admin/settings` 页面时
- **则** 在现有配置卡片（基本信息、显示设置）后显示 AI 配置相关卡片
- **且** AI 配置包含两个卡片：
  - "AI 模型配置"卡片：显示和管理模型配置列表
  - "功能映射"卡片：为不同功能分配模型

#### 场景：AI 模型配置卡片内容
- **当** 显示 AI 模型配置卡片时
- **则** 卡片包含：
  - 卡片标题"AI 模型配置"和描述"管理用于 AI 功能的模型"
  - 模型配置列表（表格或紧凑卡片形式）
  - "添加模型"按钮
- **且** 每个模型配置显示：配置名称、提供商、模型、启用状态、操作按钮（编辑、删除、测试）

#### 场景：添加新配置对话框
- **当** 管理员点击"添加模型"按钮时
- **则** 显示模态对话框（而非跳转新页面）
- **且** 对话框包含配置表单（name、provider、model、apiKey、baseUrl、maxTokens、temperature）
- **且** 提供商选择后显示推荐的模型列表
- **且** 包含"取消"和"保存"按钮

#### 场景：编辑配置对话框
- **当** 管理员点击配置的"编辑"按钮时
- **则** 显示编辑模态对话框
- **且** 表单预填充当前配置值
- **且** API Key 显示为脱敏值，占位符提示"留空表示不修改"

#### 场景：测试配置功能
- **当** 管理员点击配置的"测试"按钮时
- **则** 调用测试 API 并显示内联加载状态
- **且** 成功时在按钮旁显示"✓ 有效，XXXms"
- **且** 失败时显示"✗ {错误原因}"

#### 场景：删除配置
- **当** 管理员点击配置的"删除"按钮时
- **则** 显示确认对话框（而非独立的删除页面）
- **且** 如果配置被功能使用，提示"该配置正在使用中，无法删除"
- **且** 确认后删除并刷新列表

#### 场景：启用/禁用配置
- **当** 管理员切换配置的启用开关时
- **则** 调用 API 更新状态
- **且** 禁用的配置在功能映射中不显示

#### 场景：功能映射卡片内容
- **当** 显示功能映射卡片时
- **则** 卡片包含：
  - 卡片标题"AI 功能映射"和描述"为不同 AI 功能分配模型"
  - 功能映射列表（每个功能一行）
- **且** 每个功能显示：功能名称、模型选择下拉框、状态标识

#### 场景：修改功能映射
- **当** 管理员更改功能的模型配置选择时
- **则** 下拉框显示所有启用的模型配置
- **且** 选择后立即调用 API 保存
- **且** 显示保存成功提示（toast）

#### 场景：未配置状态显示
- **当** 某个功能未分配模型配置时
- **则** 该行的模型选择显示"请选择模型"占位符
- **且** 显示警告图标

#### 场景：功能列表显示
- **当** 显示功能映射时
- **则** 包含以下功能：
  - 摘要生成（summary）
  - 封面生成（cover）- 显示"即将推出"标签，下拉框禁用
  - AI 搜索（search）- 显示"即将推出"标签，下拉框禁用

### Requirement: AI 摘要生成状态指示
系统应在文章编辑界面显示 AI 摘要生成状态和生成按钮。

#### 场景：文章列表显示摘要状态
- **当** 管理员查看文章列表时
- **则** 每篇文章显示摘要生成状态标识
- **且** 状态标识：
  - 'generating': 加载动画图标
  - 'done': 绿色对勾图标
  - 'failed' 或 NULL: 灰色虚线图标

#### 场景：文章编辑页显示生成按钮
- **当** 管理员编辑文章时
- **则** 在摘要输入框附近显示"生成 AI 摘要"按钮
- **且** 如果 `ai_summary_status` 为 'done'，按钮文本改为"重新生成"
- **且** 如果 `ai_summary_status` 为 'generating'，隐藏按钮

#### 场景：点击生成按钮
- **当** 管理员点击"生成 AI 摘要"按钮时
- **则** 调用 `POST /api/admin/posts/[id]/generate-summary` API
- **且** 开始轮询摘要状态
- **且** 显示"摘要生成中..."加载状态

#### 场景：生成期间锁定编辑
- **当** `ai_summary_status` 为 'generating' 时
- **则** 禁用文章编辑表单（标题、内容等输入框设为只读）
- **且** 禁用"发布"按钮和"保存"按钮
- **且** 显示锁图标提示"摘要生成中，请等待"
- **且** 半透明遮罩覆盖编辑区域

#### 场景：生成完成解锁编辑
- **当** 摘要生成完成（成功或失败）时
- **则** 解锁编辑表单和按钮
- **且** 移除加载状态和遮罩
- **如果** 成功：显示生成的摘要，允许手动编辑
- **如果** 失败：显示错误提示和"重试"按钮

#### 场景：实时更新摘要状态
- **当** 触发摘要生成后
- **则** 前端每 3 秒轮询 `GET /api/admin/posts/[id]/ai-summary-status`
- **当** 状态变为 'done' 或 'failed' 时
- **则** 停止轮询并更新 UI

### Requirement: AI 统计数据扩展
系统应在管理后台首页添加 AI 相关统计信息。

#### 场景：显示 AI 调用统计
- **当** 管理后台首页加载时
- **则** 统计数据包含以下 AI 指标：
  - `aiGeneratedPosts`: 已生成 AI 摘要的文章数
  - `aiPendingPosts`: 正在生成摘要的文章数
  - `aiFailedPosts`: 摘要生成失败的文章数
  - `aiTotalTokens`: 今日 AI 调用总 Token 数

#### 场景：API 响应包含 AI 统计
- **当** 请求 `/api/admin/stats` 成功时
- **则** 响应包含上述 AI 统计字段
- **且** 与现有统计数据（totalPosts、publishedPosts 等）一起返回

### Requirement: AI 调用日志查看
系统应提供 AI 调用日志查看界面。

#### 场景：AI 日志菜单项
- **当** 管理员登录后台时
- **则** 侧边栏导航显示"AI 日志"菜单项
- **且** 点击后跳转到 `/admin/ai/logs` 页面
- **且** AI 模型配置通过"设置"菜单项访问（不单独显示）

#### 场景：访问 AI 日志页面
- **当** 管理员点击"AI 日志"菜单项时
- **则** 跳转到 `/admin/ai/logs` 页面
- **且** 显示 AI 调用日志表格

#### 场景：日志表格内容
- **当** 显示 AI 调用日志时
- **则** 表格包含以下列：
  - 时间
  - 配置名称（如"DeepSeek 摘要"）
  - 文章标题（链接到文章编辑页）
  - 操作类型（摘要生成）
  - 提供商/模型
  - Token 使用量
  - 状态（成功/失败）
  - 响应时间
- **且** 支持按配置、状态筛选
- **且** 支持分页

#### 场景：查看失败详情
- **当** 点击失败的日志记录时
- **则** 显示详细错误信息
- **且** 包含错误消息和堆栈信息（如果可用）

## MODIFIED Requirements

### Requirement: 统计数据聚合接口
系统应提供统一的接口返回所有管理端首页所需的统计数据。

#### 场景：获取完整统计数据（扩展）
- **当** 管理端首页加载时
- **则** 系统返回包含所有统计指标的数据结构
- **且** 数据结构包含原有指标：totalPosts、publishedPosts、draftPosts、recentPosts
- **且** 数据结构包含新增指标：aiGeneratedPosts、aiPendingPosts、aiFailedPosts、aiTotalTokens
- **且** 响应为 JSON 格式

#### 场景：统计数据结构（扩展）
- **当** 返回统计数据时
- **则** 响应包含以下字段：
  - `totalPosts`: 文章总数（整数）
  - `publishedPosts`: 已发布文章数（整数）
  - `draftPosts`: 草稿文章数（整数）
  - `recentPosts`: 最近7天新增文章数（整数）
  - `aiGeneratedPosts`: 已生成 AI 摘要的文章数（整数）
  - `aiPendingPosts`: 正在生成摘要的文章数（整数）
  - `aiFailedPosts`: 摘要生成失败的文章数（整数）
  - `aiTotalTokens`: 今日 AI 调用总 Token 数（整数）
