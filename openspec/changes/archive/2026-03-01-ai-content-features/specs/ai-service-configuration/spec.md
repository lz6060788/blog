# AI Service Configuration

## ADDED Requirements

### Requirement: AI 模型配置管理界面
系统应提供管理后台的 AI 模型配置管理界面，允许管理员添加、编辑、删除多个 AI 模型配置。

#### 场景：访问 AI 模型配置页面
- **当** 管理员访问 `/admin/ai/model-configs` 页面时
- **则** 显示 AI 模型配置列表
- **且** 需要管理员权限验证

#### 场景：模型配置列表显示
- **当** 显示模型配置列表时
- **则** 每个配置显示：
  - 配置名称
  - 提供商图标/名称
  - 模型名称
  - 启用状态（开关）
  - 操作按钮（编辑、删除、测试）

#### 场景：添加新模型配置
- **当** 管理员点击"添加模型"按钮时
- **则** 显示配置表单对话框
- **且** 表单包含所有必需字段

#### 场景：配置表单字段
- **当** 显示配置表单时
- **则** 包含以下字段：
  - `name`: 文本输入，配置名称（如"DeepSeek 摘要专用"）
  - `provider`: 选择框（DeepSeek、智谱 GLM、通义千问、月之暗面、百川智能、OpenAI）
  - `model`: 文本输入（如 deepseek-chat、glm-4-flash）
  - `apiKey`: 密码输入框
  - `baseUrl`: 可选文本输入框（自定义 endpoint）
  - `maxTokens`: 数字输入框（默认 300）
  - `temperature`: 滑块或数字输入（0-2，默认 0.7）
  - `enabled`: 开关（默认开启）

#### 场景：提供商选择联动
- **当** 选择不同的 provider 时
- **则** model 输入框显示该提供商的常用模型建议
- **且** 提供商与建议模型：
  - DeepSeek: `deepseek-chat`, `deepseek-coder`
  - 智谱 GLM: `glm-4-flash`, `glm-4-plus`, `glm-4-air`
  - 通义千问: `qwen-turbo`, `qwen-plus`, `qwen-max`
  - 月之暗面: `moonshot-v1-8k`, `moonshot-v1-32k`
  - 百川智能: `Baichuan2-Turbo`
  - OpenAI: `gpt-4o`, `gpt-4o-mini`

### Requirement: AI 模型配置 API
系统应提供 API 端点管理 AI 模型配置。

#### 场景：获取所有模型配置
- **当** 向 `GET /api/admin/ai/model-configs` 发出请求时
- **且** 用户已通过管理员认证
- **则** 系统返回所有模型配置列表
- **且** 响应状态为 200
- **且** API Key 脱敏（只显示前 4 位）

#### 场景：创建新模型配置
- **当** 向 `POST /api/admin/ai/model-configs` 发出请求时
- **且** 请求体包含有效配置数据
- **且** 用户已通过管理员认证
- **则** 系统在 `ai_model_configs` 表插入新记录
- **且** API Key 被加密后存储
- **且** 响应状态为 201

#### 场景：更新模型配置
- **当** 向 `PUT /api/admin/ai/model-configs/[id]` 发出请求时
- **且** 请求体包含更新后的配置数据
- **且** 用户已通过管理员认证
- **则** 系统更新指定配置
- **且** 更新 `updated_at` 时间戳
- **且** 如果请求体包含新 apiKey，则加密替换
- **且** 响应状态为 200

#### 场景：删除模型配置
- **当** 向 `DELETE /api/admin/ai/model-configs/[id]` 发出请求时
- **且** 用户已通过管理员认证
- **则** 系统删除指定配置
- **且** 如果该配置被功能映射引用，返回 400 错误
- **且** 错误消息："该配置正在被使用，请先修改功能映射"

#### 场景：启用/禁用模型配置
- **当** 向 `PATCH /api/admin/ai/model-configs/[id]/toggle` 发出请求时
- **且** 用户已通过管理员认证
- **则** 系统切换配置的 `enabled` 状态
- **且** 返回更新后的配置

### Requirement: 功能映射管理
系统应提供功能与模型配置的映射管理。

#### 场景：访问功能映射页面
- **当** 管理员访问 `/admin/ai/function-mappings` 页面时
- **则** 显示功能映射配置
- **且** 需要管理员权限验证

#### 场景：功能映射显示
- **当** 显示功能映射时
- **则** 每个功能显示：
  - 功能名称（摘要生成、封面生成、AI 搜索）
  - 当前分配的模型配置（下拉选择）
  - 状态（已配置/未配置）

#### 场景：获取功能映射 API
- **当** 向 `GET /api/admin/ai/function-mappings` 发出请求时
- **且** 用户已通过管理员认证
- **则** 系统返回所有功能映射
- **且** 响应包含：
  - `functionName`: 功能名称
  - `modelConfigId`: 分配的模型配置 ID
  - `modelName`: 模型名称
  - `status`: 配置状态（configured/unconfigured）

#### 场景：更新功能映射
- **当** 向 `PUT /api/admin/ai/function-mappings` 发出请求时
- **且** 请求体包含 `{ functionName, modelConfigId }`
- **且** 用户已通过管理员认证
- **则** 系统更新或创建功能映射记录
- **且** 响应状态为 200

### Requirement: 配置测试
系统应提供测试模型配置的功能。

#### 场景：测试单个配置
- **当** 管理员点击配置列表中的"测试"按钮时
- **则** 系统调用 `POST /api/admin/ai/model-configs/[id]/test`
- **且** 使用该配置发送简单测试请求到 AI 服务
- **且** 显示测试结果（成功/失败、响应时间）

#### 场景：配置测试 API
- **当** 向 `POST /api/admin/ai/model-configs/[id]/test` 发出请求时
- **且** 用户已通过管理员认证
- **则** 系统使用指定配置调用 AI 服务
- **且** 发送简单提示词（如 "Hi"）
- **且** 成功时返回 200 和 `{ success: true, responseTime: 123, message: "..." }`
- **且** 失败时返回 400 和 `{ success: false, error: "..." }`

#### 场景：测试结果展示
- **当** 测试成功时
- **则** 显示"配置有效，响应时间 XXXms"
- **且** 显示 AI 返回的测试消息
- **当** 测试失败时
- **则** 显示具体错误信息（如 API Key 无效、网络错误）

### Requirement: 配置验证
系统应验证配置数据的合法性。

#### 场景：必需字段验证
- **当** 保存配置时
- **则** 系统验证 name、provider、model、apiKey 不为空
- **且** 验证失败时返回 400 和具体错误信息

#### 场景：模型名称格式验证
- **当** 输入 model 名称时
- **则** 系统验证格式合法（小写字母、数字、连字符）
- **且** 格式错误时提示"模型名称格式不正确"

#### 场景：API Key 格式验证
- **当** 输入 API Key 时
- **则** 系统验证长度（至少 20 字符）
- **且** 不同提供商有不同的 Key 前缀验证：
  - DeepSeek: 以 `sk-` 开头
  - 智谱: 格式验证
  - 通义千问: 以 `sk-` 开头

#### 场景：配置名称唯一性验证
- **当** 创建新配置时
- **则** 系统验证 name 在所有配置中唯一
- **且** 重复时返回错误"配置名称已存在"

### Requirement: AI 配置权限控制
系统应限制只有管理员可以访问和修改 AI 配置。

#### 场景：管理员权限验证
- **当** 访问 AI 配置页面或 API 时
- **则** 系统验证用户是否在管理员白名单中
- **且** 非管理员用户返回 403 禁止访问

#### 场景：配置编辑权限
- **当** 普通用户访问 `/admin/ai/model-configs` 时
- **则** 显示"权限不足"提示
- **且** 不显示配置列表

### Requirement: 配置 UI 交互优化
系统应提供良好的配置界面用户体验。

#### 场景：API Key 安全显示
- **当** 编辑已有配置时
- **则** apiKey 输入框显示脱敏值（如 `sk-12****`）
- **且** 占位符提示"留空表示不修改"
- **且** 新增配置时为空输入框

#### 场景：保存成功提示
- **当** 配置保存成功时
- **则** 显示成功提示消息
- **且** 自动关闭对话框
- **且** 刷新配置列表

#### 场景：删除确认
- **当** 点击删除按钮时
- **则** 显示确认对话框
- **且** 提示"确定要删除此配置吗？"
- **且** 确认后执行删除

#### 场景：配置状态指示
- **当** 配置被功能使用时
- **则** 配置卡片显示"正在使用"标签
- **且** 删除按钮禁用或隐藏

### Requirement: 首次配置引导
系统应引导管理员完成首次 AI 配置。

#### 场景：检测未配置状态
- **当** 系统检测到没有任何可用的模型配置时
- **则** 在管理后台首页显示提示卡片
- **且** 提示"AI 功能尚未配置，点击前往配置"
- **且** 点击后跳转到 AI 模型配置页面

#### 场景：功能未配置提示
- **当** 某个功能（如摘要生成）没有分配模型配置时
- **则** 使用该功能时显示提示"请先在管理后台配置 AI 模型"
- **且** 提供跳转链接到配置页面
